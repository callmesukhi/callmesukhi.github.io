name: Send Email on Approved Label

on:
  issues:
    types:
      - labeled

permissions:
  issues: read
  contents: read
 
jobs:
  send_email:
    if: github.event.label.name == 'Approved'
    runs-on: ubuntu-latest
    permissions:
        issues: write
        contents: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        
      - name: üßπ Sanitize issue body and save to file
        id: sanitize
        continue-on-error: true
        run: |
          ISSUE_BODY=$(jq -r '.issue.body' "$GITHUB_EVENT_PATH")
          ISSUE_BODY=$(echo "$ISSUE_BODY" | sed -E 's/(^|[^`])`([^`]+)`([^`]|$)/\1**\2**\3/g')
          inside_block=false
          while IFS= read -r line; do
            if [[ "$line" =~ ^\`\`\` ]]; then
              if [ "$inside_block" = false ]; then
                inside_block=true
              else
                inside_block=false
              fi
              echo "> $line"
            elif [ "$inside_block" = true ]; then
              echo "> $line"
            else
              echo "$line"
            fi
          done <<< "$ISSUE_BODY" > issue-body.txt


      - name: ‚úçÔ∏è Create markdown email template
        id: compose
        continue-on-error: true
        run: |
          cat <<'EOF' > email-template.md
          üöÄ An issue has been marked as **Approved**!
          
          ### Title
          $ISSUE_TITLE
          
          ### Author
          $ISSUE_AUTHOR
          
          ### URL
          $ISSUE_URL
          
          ### Issue Body
          $ISSUE_BODY
          EOF

          export ISSUE_TITLE="${{ github.event.issue.title }}"
          export ISSUE_AUTHOR="${{ github.event.issue.user.login }}"
          export ISSUE_URL="${{ github.event.issue.html_url }}"
          export ISSUE_BODY="$(cat issue-body.txt)"
          envsubst < email-template.md > email.md
               
      - name: üì≤ Convert markdown to HTML
        id: convert
        continue-on-error: true
        run: |
          sudo apt-get update && sudo apt-get install -y pandoc
          pandoc email.md -f markdown -t html -s \
            -o generated-email.html \
            --metadata title="Request Approved"
        
      - name: üìß Send email notification
        id: send_email
        uses: dawidd6/action-send-mail@v4
        continue-on-error: true
        with:
          connection_url: ${{secrets.MAIL_CONNECTION}}
          subject: "‚úÖ Request approved!"
          to: ${{ secrets.MAIL_TO }}
          from: ${{ secrets.MAIL_FROM }}
          reply_to: ${{ secrets.MAIL_REPLY_TO }}
          cc: ${{ secrets.MAIL_CC }}
          # bcc: ${{ secrets.MAIL_BCC }}
          # convert_markdown: true
          # envelope_from: mailer@example.com
          # attachments: attachments.zip,git.diff,./dist/static/*.js
          # body: 
          html_body: file://generated-email.html


      - name: üìù Handle success or failure
        if: always()
        run: |
          echo "Email step result: ${{ steps.send_email.outcome }}"
          echo "Email step conclusion: ${{ steps.send_email.conclusion }}"
          COMMENT_URL="https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments"
          EMAIL_DOMAIN=$(echo "${{ secrets.MAIL_TO }}" | awk -F '@' '{print $2}')

          if [ "${{ steps.sanitize.conclusion }}" != "success" ] || \
             [ "${{ steps.compose.conclusion }}" != "success" ] || \
             [ "${{ steps.convert.conclusion }}" != "success" ]; then
            curl -s -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -d '{"body":"‚ùå Failed to compose message due to a processing error."}' "$COMMENT_URL"
            exit 0
          fi

          if [ "${{ steps.send_email.conclusion }}" != "success" ]; then
            curl -s -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -d '{"body":"‚ùå @${{ github.event.issue.user.login }}, sending request to \`$EMAIL_DOMAIN\` failed. Please check workflow logs."}' "$COMMENT_URL"
            exit 0
          fi

          curl -s -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -d "{\"body\": \"‚úÖ Request sent successfully to \`$EMAIL_DOMAIN\`\"}" "$COMMENT_URL"

          curl -s -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -d '{"labels": ["Request Sent"]}' \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/labels"
