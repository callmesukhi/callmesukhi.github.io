name: Send Email on Approved Label

on:
  issues:
    types:
      - labeled

permissions:
  issues: read
  contents: read
 
jobs:
  send_email:
    if: github.event.label.name == 'Approved'
    runs-on: ubuntu-latest
    permissions:
        issues: read
        contents: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        
      - name: ðŸ§¹ Sanitize issue body (code â†’ bold)
        run: |
          body="${{ github.event.issue.body }}"
      
          # Convert inline `code` to bold
          body=$(echo "$body" | sed -E 's/`([^`]*)`/**\1**/g')
      
          # Convert fenced blocks (```...```) to bold text block
          body=$(echo "$body" | sed -E '/^```/,/^```/s/^/**/' | sed -E '/^```/d')
      
          echo "$body" > issue-body.txt
          
      - name: ðŸ¦¾ Build final markdown with sanitized issue body
        run: |
         cat <<'EOF' > email.md
         ðŸš€ An issue has been marked as **Approved**!

         ### Title
         ${{ github.event.issue.title }}
            
         ### Author
         ${{ github.event.issue.user.login }}
                      
         ### URL
         ${{ github.event.issue.html_url }}
                      
         ### Issue Body
         $(cat issue-body.txt)
         EOF
         
      - name: ðŸ“² Convert markdown to HTML
        run: |
          sudo apt-get update && sudo apt-get install -y pandoc
          pandoc email.md -f markdown -t html -s -o generated-email.html --metadata title="Request Approved"
        
      - name: ðŸ“§ Send email notification
        uses: dawidd6/action-send-mail@v4
        with:
          connection_url: ${{secrets.MAIL_CONNECTION}}
          subject: "âœ… Request approved!"
          to: ${{ secrets.MAIL_TO }}
          from: ${{ secrets.MAIL_FROM }}
          reply_to: ${{ secrets.MAIL_REPLY_TO }}
          cc: ${{ secrets.MAIL_CC }}
          # bcc: ${{ secrets.MAIL_BCC }}
          # convert_markdown: true
          # envelope_from: mailer@example.com
          # attachments: attachments.zip,git.diff,./dist/static/*.js
          # body: |
          #   ðŸš€ An issue has been marked as **Approved**!

          #   ### Title
          #   ${{ github.event.issue.title }}

          #   ### Author
          #   ${{ github.event.issue.user.login }}

          #   ### URL
          #   ${{ github.event.issue.html_url }}

          #   ### Issue Body
          #   ${{ github.event.issue.body }}
          html_body: file://generated-email.html
